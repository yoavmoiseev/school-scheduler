---
title: "Процесс правки переводов (New overrides)"
---

Цель
-
Коротко описать новый, безопасный и обратимый процесс внесения правок переводов, который следует использовать для всех дальнейших исправлений.

Ключевые файлы
-
- `services/i18n.py` — основной загрузчик переводов; подхватывает `i18n_he.json`/`i18n_ru.json` и новые файлы `i18n_text_new.json`, `i18n_he_new.json`, `i18n_ru_new.json`.
- `services/i18n_text_new.json`, `services/i18n_he_new.json`, `services/i18n_ru_new.json` — файлы-override (частичные или полные). Используются для внесения правок без изменения `GUI_TEXT`.
- `scripts/export_i18n_new.py` — утилита для экспорта текущих массивов в шаблоны `i18n_*_new.json`.
- `static/js/i18n.js` — клиент загружает `/api/i18n/<lang>` и применяет `overrides` для hardcoded строк.

Форматы файлов `i18n_*_new.json`
-
- Полный список: JSON-массив длиной ровно как `GUI_TEXT` — полностью заменяет соответствующий массив (только при совпадении длины).
- Частичные переопределения: JSON-объект. Ключи могут быть:
  - числовой индекс (строкой или числом): {"123": "новый текст"} — заменит элемент с индексом 123;
  - точная английская фраза: { "Add Teacher": "הוספת מורה" } — применится ко всем вхождениям этой английской строки.

Правила безопасности
-
- Никогда не редактировать `GUI_TEXT`, `GUI_TEXT_HE`, `GUI_TEXT_RU` напрямую в `services/i18n.py` — это ломает индексы.
- Все правки делаются только в `i18n_*_new.json` (частичные overrides) или через экспорт/замену полных списков.
- Перед применением любой записи ассистент показывает: английский ключ → предложенные переводы (HE / RU) и ждёт ОК.

Пошаговый рабочий процесс (для каждого ключа)
-
1. Вы даёте английскую фразу (точно как в коде/шаблонах или как в GUI).
2. Ассистент ищет все вхождения в `templates/`, `static/js/`, `routes/` и `services/`.
3. Ассистент предлагает переводы (HE и RU) и показывает патч (строка/файл/JSON-entry).
4. Вы подтверждаете ОК.
5. Ассистент вносит запись в `services/i18n_he_new.json` и `services/i18n_ru_new.json` (или в `i18n_text_new.json`, если нужно) — как частичный override по английской фразе или индексу.
6. Вы перезапускаете сервер: `python app.py` и делаете жесткую перезагрузку страницы (Ctrl+F5).

Как обрабатывать hardcoded строки в GUI
-
- Если строка не найдена в `GUI_TEXT` (hardcoded), используем string-key overrides: добавляем запись в `i18n_*_new.json` по английской фразе.
- Сервер возвращает клиенту `{texts: [...], overrides: {...}}`. Клиент применяет `overrides` при отсутствии соответствия по индексу.

Команды
-
Экспорт текущих массивов (создает полные JSON-шаблоны):
```
python scripts/export_i18n_new.py
```

Запуск сервера (dev):
```
python app.py
```

Проверка изменений в браузере: сделать полную перезагрузку страницы (Ctrl+F5) и посмотреть диалоги/модальные окна, где применяются переводы.

Отладка
-
- Если перевод не появился — проверьте в консоли браузера, что `/api/i18n/<lang>` возвращает объект с полем `overrides`.
- При необходимости ассистент может включить временные визуальные метки или логи для отсутствующих переводов.

Контракт взаимодействия (что делает ассистент)
-
- Всегда показывает предложенный перевод перед записью.
- Вносит изменения только в `i18n_*_new.json`.
- Не трогает `GUI_TEXT` или существующие JSON, если вы не дали явное разрешение.

Примечание
-
Файл `TRANSLATION_PROCESS.RMD` — официальная запись процесса в репозитории. Соблюдайте его при всех будущих правках переводов.

GUI / Графические правки
-
При правке строк, вставленных напрямую в шаблоны или JS (hardcoded), соблюдайте следующий аккуратный процесс,
чтобы не сломать индексы и обеспечить обратимость правок:

1. Найдите вхождение строки (точная английская фраза) в проекте: `templates/`, `static/js/`, `routes/`, `services/`.
  - Используйте `grep` или поиск в IDE по точной строке.
2. Предложите заменить hardcoded-строку на i18n-ключ:
  - В Jinja-шаблоне: заменить `Some text` на `{{ _('Some text') }}` или на атрибут `data-i18n="Some text"` если удобнее для JS.
  - В JS: использовать глобальную функцию `_('Some text')` или `I18N.t('Some text')`.
3. Подготовьте перевод (HE/RU) в виде string-key override (точная английская фраза) — ассистент предложит варианты.
4. Ассистент показывает diff (файл/строка до→после) и JSON-override, ждёт вашего ОК.
5. После ОК ассистент вносит запись в `services/i18n_he_new.json` и `services/i18n_ru_new.json`.
6. Зафиксируйте изменения в логе `TRANSLATION_CHANGES.md` (ключ, файлы, дата, кто внёс перевод).
7. Перезапустите сервер и сделайте жесткую перезагрузку страницы (Ctrl+F5). Проверьте отображение.
8. Если перевод не появился — включите режим отладки: ассистент может временно пометить отсутствующие переводы визуально или логировать ответ `/api/i18n/<lang>`.

Запись изменений (Translate)
-
Каждое изменение ассистента сопровождается записью в `TRANSLATION_CHANGES.md` со следующей информацией:
- Дата и время
- Английский ключ (точно)
- Предложенные переводы (HE, RU)
- Файлы, где произведены правки (шаблон/JS и `i18n_*_new.json`)
- Короткое описание причины правки

Следуя этим шагам, все будущие переводы и GUI-правки будут выполняться одинаково, аккуратно и обратимо.
