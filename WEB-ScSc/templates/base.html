<!DOCTYPE html>
<html lang="{{ current_lang }}" dir="{{ 'rtl' if is_rtl else 'ltr' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/schedule_grid.css') }}" rel="stylesheet">
)</head>
<body>
    {% set lang_code = 'ru' if current_lang in ['Russian', '泻懈泄'] else ('he' if current_lang in ['Hebrew', '注专转'] else 'en') %}
    <!-- Top Toolbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">{{ app_name }}</span>
            <div class="d-flex gap-2 flex-wrap align-items-center">
                <!-- Small promotional video -->
                <video id="nav-promo-video" class="nav-promo-video" autoplay loop muted playsinline ondblclick="showVideoModal()">
                    <source src="{{ url_for('static', filename='video/' + lang_code + '.mp4') }}" type="video/mp4">
                </video>
                {% if user %}
                <span class="text-muted me-3"> {{ user.first_name }} {{ user.last_name }}</span>
                {% endif %}
                <button id="import-top-btn" class="btn btn-sm btn-outline-secondary" onclick="showImportModal()">{{ _(67) }}</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportExcel()">{{ _(68) }}</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="saveToFavorites()">{{ _('Save to Favorites') }}</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="showFavoritesModal()">{{ _('Load from Favorites') }}</button>
                <button class="btn btn-sm btn-outline-warning" onclick="rebuildAll()">{{ _('Rebuild All') }}</button>
                <button class="btn btn-sm btn-outline-danger" onclick="clearAllSchedules()">{{ _(70) }}</button>
                <button class="btn btn-sm btn-outline-danger" onclick="clearAllData()">{{ _('Clear All Data') }}</button>
                {% if user %}
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">{{ _('Logout') }}</button>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <div class="container-fluid mt-3">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="teachers-tab" data-bs-toggle="tab" href="#teachers" role="tab">{{ _(3) }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="groups-tab" data-bs-toggle="tab" href="#groups" role="tab">{{ _(4) }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="subjects-tab" data-bs-toggle="tab" href="#subjects" role="tab">{{ _(5) }}</a>
            </li>
            <li class="nav-item">
                <span class="nav-link disabled">&nbsp;&nbsp;&nbsp;</span>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="group-scheduler-tab" data-bs-toggle="tab" href="#group-scheduler" role="tab">{{ _(7) }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="teacher-scheduler-tab" data-bs-toggle="tab" href="#teacher-scheduler" role="tab">{{ _(8) }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="day-scheduler-tab" data-bs-toggle="tab" href="#day-scheduler" role="tab">{{ _('Day Scheduler') }}</a>
            </li>
            <li class="nav-item">
                <span class="nav-link disabled">&nbsp;&nbsp;&nbsp;</span>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="configuration-tab" data-bs-toggle="tab" href="#configuration" role="tab">{{ _(9) }}</a>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabContent">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Modals -->
    {% include 'components/confirmations.html' %}
    {% include 'components/import_modal.html' %}
    {% include 'components/rebuild_modal.html' %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/api_client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
    <script src="{{ url_for('static', filename='js/form_handlers.js') }}"></script>
    <script>
        // Logout function
        async function logout() {
            if (confirm(_('Are you sure you want to logout?'))) {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    alert(_('Logout failed'));
                }
            }
        }
        
        // Global error handler for unauthorized requests
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Unauthorized')) {
                window.location.href = '/login';
            }
        });
        
        // Import functions
        async function showImportModal() {
            // First show a confirmation modal so it appears in front
            Confirmations.show(
                _('Confirm'),
                _('All existing data will be erased. An Export to Excel will run first. Continue?'),
                async (confirmed) => {
                    if (!confirmed) return;

                    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('importModal'));
                    modal.show();

                    // Load available files
                    try {
                        const result = await API.get('/api/import/list-files');
                        const select = document.getElementById('importFileSelect');
                        select.innerHTML = '';

                        if (result.files && result.files.length > 0) {
                            result.files.forEach(file => {
                                const option = document.createElement('option');
                                option.value = file.name;
                                option.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                                select.appendChild(option);
                            });
                        } else {
                            select.innerHTML = '<option value="">{{ _('No files found in ExcelExamples') }}</option>';
                        }
                    } catch (error) {
                        console.error('Failed to load files:', error);
                    }
                }
            );
        }
        
        async function executeImport() {
            const topBtn = document.getElementById('import-top-btn');
            const modalBtn = document.getElementById('import-modal-btn');
            const fileInput = document.getElementById('importFileInput');
            const select = document.getElementById('importFileSelect');
            const resultDiv = document.getElementById('importResult');

            if (topBtn) topBtn.disabled = true;
            if (modalBtn) modalBtn.disabled = true;

            // show status
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info';
            resultDiv.textContent = "{{ _('Importing...') }}";

            // run export (open download in new tab so we can continue)
            const expRes = await exportExcelNoNavigate();
            if (!expRes || !expRes.success) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = '{{ _('Export failed') }}: ' + (expRes && expRes.error ? expRes.error : '');
                if (topBtn) topBtn.disabled = false;
                return;
            }

            // clear all data without extra confirmation
            const clearRes = await clearAllDataNoConfirm();
            if (!clearRes || !clearRes.success) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = '{{ _('Clear failed') }}' + ': ' + (clearRes && clearRes.error ? clearRes.error : '');
                if (topBtn) topBtn.disabled = false;
                return;
            }

            // proceed with original import flow
            // If user selected a local file -> upload via multipart
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const fd = new FormData();
                fd.append('file', fileInput.files[0]);
                try {
                    const resp = await fetch('/api/import/upload', { method: 'POST', body: fd });
                    const result = await resp.json();
                    if (result.success) {
                        resultDiv.className = 'alert alert-success';
                        resultDiv.innerHTML = `{{ _('Import completed') }}`;
                        setTimeout(() => { location.reload(); }, 1200);
                    } else {
                        resultDiv.className = 'alert alert-danger';
                        resultDiv.textContent = '{{ _('Import failed') }}: ' + (result.error || '');
                    }
                } catch (error) {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.textContent = '{{ _('Import failed') }}: ' + error.message;
                }
                if (topBtn) topBtn.disabled = false;

                return;
            }

            // Otherwise use selected example file
            const filename = select ? select.value : '';
            if (!filename) {
                resultDiv.className = 'alert alert-warning';
                resultDiv.textContent = '{{ _('Please select a file or choose a local file') }}';
                if (topBtn) topBtn.disabled = false;
                return;
            }

            try {
                const result = await API.post('/api/import/from-file', { filename });

                if (result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        {{ _('Import completed') }}<br>
                        Teachers: ${result.teachers.added} added, ${result.teachers.updated} updated<br>
                        Groups: ${result.groups.added} added, ${result.groups.updated} updated<br>
                        Subjects: ${result.subjects.added} added, ${result.subjects.updated} updated
                    `;
                    setTimeout(() => { location.reload(); }, 2000);
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.textContent = '{{ _('Import failed') }}: ' + result.error;
                }
            } catch (error) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = '{{ _('Import failed') }}: ' + error.message;
            }
            if (topBtn) topBtn.disabled = false;
        }

        // Reset modal button state when modal is opened
        const importModal = document.getElementById('importModal');
        if (importModal) {
            importModal.addEventListener('show.bs.modal', function() {
                const modalBtn = document.getElementById('import-modal-btn');
                if (modalBtn) modalBtn.disabled = false;
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/confirmations.js') }}"></script>
    
    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <a href="{% if current_lang in ['Hebrew', '注专转'] %}https://yoavmoiseev.github.io/YaM-Soft/projects-he.html{% elif current_lang in ['Russian', '泻懈泄'] %}https://yoavmoiseev.github.io/YaM-Soft/projects-ru.html{% else %}https://yoavmoiseev.github.io/YaM-Soft/projects-en.html{% endif %}" 
                           target="_blank">
                            {% if current_lang in ['Hebrew', '注专转'] %}
                             住祝
                            {% else %}
                            YaM Soft
                            {% endif %}
                        </a>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="modal-promo-video" class="modal-promo-video" autoplay loop muted playsinline>
                        <source src="{{ url_for('static', filename='video/' + lang_code + '.mp4') }}" type="video/mp4">
                    </video>
                </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showVideoModal() {
            const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
            videoModal.show();
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
